### 25/7/12å…¬å¼€ä»“åº“è¯´æ˜
æ­¤ä»“åº“ä»£ç å‡ä¸ºæœ¬äººæ‰€å†™ï¼Œå­¦å¼Ÿå­¦å¦¹å‚è€ƒéœ€è°¨æ…ï¼Œå¹¶ä¸”æ¯å¹´çš„è¯­æ³•è§„åˆ™åº”è¯¥éƒ½ä¼šä¸ä¸€æ ·ã€‚ï¼ˆä¸ªäººè§‰å¾—è¯­æ³•åˆ†æä¹‹å‰çš„ä»£ç è¿˜ç®—å¯ä»¥ï¼Œåé¢çš„å¾ˆçƒ‚è¡¥è¯å‚è€ƒäº†ç«é€Ÿä¹Ÿå¾ˆæ…¢ğŸ¤ï¼‰

> ã€Šç¼–è¯‘æŠ€æœ¯ã€‹å®éªŒå¼€å‘æ–‡æ¡£
>
> Authorï¼šbush

# 1 å‚è€ƒç¼–è¯‘å™¨ä»‹ç»

ä¸»è¦å‚è€ƒäº†æ•™æä¸ŠPL/0ä»¥åŠtolang

## 1.1 æ€»ä½“ç»“æ„

PL/0æ˜¯ä¸€ä¸ªç¼–è¯‘-è§£é‡Šæ‰§è¡Œç¨‹åºï¼Œæ€»ä½“ç»“æ„åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š

1. å…ˆæŠŠPL/0ç¼–è¯‘æˆç›®æ ‡ç¨‹åºï¼ˆP-codeæŒ‡ä»¤ï¼‰
2. å†å¯¹ç›®æ ‡ç¨‹åºè¿›è¡Œè§£é‡Šæ‰§è¡Œï¼Œå¾—åˆ°è¿è¡Œç»“æœ

## 1.2 æ¥å£è®¾è®¡

PL/0ç¼–è¯‘ç¨‹åºé‡‡ç”¨ä¸€éæ‰«æï¼Œä»¥è¯­æ³•åˆ†æä¸ºæ ¸å¿ƒï¼Œç”±å®ƒè°ƒç”¨è¯æ³•åˆ†æç¨‹åºå–å•è¯ï¼Œåœ¨è¯­æ³•åˆ†æè¿‡ç¨‹ä¸­åŒæ—¶è¿›è¡Œè¯­ä¹‰åˆ†æå¤„ç†ï¼Œå¹¶ç”Ÿæˆç›®æ ‡æŒ‡ä»¤ã€‚

å¦‚é‡æœ‰è¯­æ³•ã€è¯­ä¹‰é”™è¯¯ï¼Œåˆ™éšæ—¶è°ƒç”¨å‡ºé”™å¤„ç†ç¨‹åºï¼Œæ‰“å°å‡ºé”™ä¿¡æ¯ã€‚

## 1.3 æ–‡ä»¶ç»„ç»‡

å‰ç«¯å’Œåç«¯åˆ†åŒ…ç­‰ã€‚

# 2 ç¼–è¯‘å™¨æ€»ä½“è®¾è®¡

## 2.1 æ€»ä½“ç»“æ„

æ€»ä½“ç»“æ„ä¸PL/0ä¸åŒï¼Œæ˜¯ç¼–è¯‘ç¨‹åºã€‚

1. å…ˆç¼–è¯‘æˆLLVM IR
2. ç”±LLVM IRç”ŸæˆMIPSæ±‡ç¼–ä»£ç 
3. ç›´æ¥è¿è¡ŒMIPSæ±‡ç¼–ä»£ç 

---

ç¼–è¯‘å™¨æ€»ä½“é‡‡ç”¨å¤šéæ‰«æï¼Œå³å…ˆé€šè¿‡ä¸€æ¬¡å®Œæ•´çš„è¯æ³•åˆ†æå¾—åˆ°tokenåºåˆ—ï¼Œå†è¿›è¡Œè¯­æ³•åˆ†æå¾—åˆ°è¯­æ³•æ ‘ã€‚

## 2.2 æ¥å£è®¾è®¡

### 2.2.1 è¯æ³•åˆ†æå™¨Lexer

`Lexer.java`ä¸»è¦æä¾›ä¸€ä¸ªæ¥å£`getToken()`

- **è°ƒç”¨å½¢å¼**ï¼š`token = lexer.getToken()`
- **ä½œç”¨**ï¼šæ ¹æ®è®¾ç½®çš„è¯»å–å™¨`BufferedReader`ï¼Œæ¯æ¬¡è°ƒç”¨è¿”å›ä¸‹ä¸€ä¸ªè§£æåˆ°çš„`Token`ç±»ç¬¦å·
- **å¤‡æ³¨**ï¼šå½“ä¸”ä»…å½“è¯»åˆ°æ–‡ä»¶æµæœ«å°¾æ—¶è¿”å›`null`

### 2.2.2 è¯­æ³•åˆ†æå™¨Parser

`Parser.java`ä¸»è¦æä¾›ä¸€ä¸ªæ¥å£`parse()`

- **è°ƒç”¨å½¢å¼**ï¼š`compUnit = parser.parse()`
- **ä½œç”¨**ï¼šé¦–å…ˆè°ƒç”¨è¯æ³•åˆ†æå™¨çš„æ¥å£è§£æå¾—åˆ°tokenåºåˆ—ï¼Œç„¶åé€’å½’è§£æä»¥ä¸€ä¸ª`CompUnit`ç±»å®ä¾‹è¡¨ç¤ºçš„è¯­æ³•æ ‘

## 2.3 æ–‡ä»¶ç»„ç»‡

```
# ä¸»è¦æ–‡ä»¶ç»“æ„å¦‚ä¸‹
â”œâ”€error
â”‚  â””â”€CompilerError.java
â”œâ”€frontend
â”‚  â”œâ”€lexer
â”‚  â”‚   â””â”€Lexer.java
â”‚  â””â”€parser
â”‚      â”œâ”€declaration
â”‚      â”œâ”€expression
â”‚      â”œâ”€function
â”‚      â”œâ”€statement
â”‚      â””â”€terminal
â”‚      â””â”€Parser.java
â”œâ”€Compiler.java
â”œâ”€config.json
â””â”€README.md
```

# 3 è¯æ³•åˆ†æè®¾è®¡

## 3.1 ç¼–ç å‰çš„è®¾è®¡

ä¸»è¦å‚è€ƒçš„æ˜¯æ•™æä¸Šçš„PL/0ï¼Œä»¥åŠç¬¬ä¸‰ç« çš„è¯æ³•åˆ†æç¤ºä¾‹ã€‚

![image-20241014104848084](https://cdn.jsdelivr.net/gh/bush-cn/TyporaImages@main/img/2025/07/11/20250711101424.png)

ä»£ç å¤§è‡´æµç¨‹å›¾å¦‚ä¸Šï¼Œç¼–ç æ—¶ï¼Œä¸»è¦ä¾é è¿™å¼ å›¾ï¼Œå…¶ä»–ç»†èŠ‚åœ¨ç¼–ç æ—¶å®ç°ã€‚

`Compiler.java`è¿™ä¸€ä¸»ç¨‹åºè°ƒç”¨`frontedn/Lexer.java`ä¸­çš„`getSymbol`æ–¹æ³•ã€‚åœ¨æ­¤æ¬¡ä½œä¸šä¸­ä¸»é€»è¾‘è¿˜æœªå®ç°ï¼Œå› æ­¤å¯ä»¥åœ¨`Compiler.java`ä¸­æš‚æ—¶ç¼–å†™æ»¡è¶³æœ¬æ¬¡ä½œä¸šçš„æµ‹è¯•é€»è¾‘ã€‚

## 3.2 ç¼–ç å®Œæˆåçš„ä¿®æ”¹

### 3.2.1 è®¾è®¡æ¨¡å¼çš„é€‰æ‹©ã€ç±»çš„è®¾è®¡

- è¯æ³•åˆ†æå™¨`Lexer.java`é‡‡ç”¨å•ä¾‹æ¨¡å¼ï¼ˆé¥¿æ±‰å¼ï¼‰çš„è®¾è®¡æ¨¡å¼ï¼Œä½œä¸ºä¸€ä¸ªé™æ€ç±»å­˜æ”¾åˆ°ä¸»ç±»`Compiler.java`ä¸­ï¼Œå…¶æ–¹æ³•ä¹Ÿå¤šæ˜¯é™æ€æ–¹æ³•ï¼Œæœ€ä¸»è¦çš„æ˜¯`getToken`æ–¹æ³•ï¼›
  ![image-20241014104957471](https://cdn.jsdelivr.net/gh/bush-cn/TyporaImages@main/img/2025/07/11/20250711101443.png)
- å•è¯tokenä½œä¸ºä¸€ä¸ªç±»`Token`ï¼Œç±»å‹ä½œä¸ºå…¶å†…éƒ¨æšä¸¾ç±»`TokenType`ï¼›
- ç¼–è¯‘é”™è¯¯çš„å¤„ç†ï¼š`CompilerError`æ˜¯ä¸€ä¸ª`Exception`çš„å­ç±»ï¼Œåœ¨`Lexer`ç­‰å„ä¸ªç»„ä»¶çš„æ–¹æ³•å¯ä»¥è¢«æŠ›å‡ºï¼Œåœ¨ä¸»ç±»`Compiler`ä¸­è¢«`try-catch`å¤„ç†ã€‚

### 3.2.2 å…¶ä»–æ›´æ”¹æˆ–BUG

1. æœ€å¤§çš„ç–å¿½æ˜¯å¿˜è®°æ·»åŠ å¤„ç†æ³¨é‡Šçš„ä»£ç äº†ï¼Œåº”è¯¥æŠŠè¯»å…¥`/`ç¬¦å·åçš„é€»è¾‘å•åˆ—å‡ºæ¥ã€‚
2. å¦å¤–ï¼Œåªè€ƒè™‘åˆ°å­—ç¬¦å¸¸é‡ä¸­åªæœ‰ä¸€ä¸ªå­—ç¬¦çš„æƒ…å†µäº†ï¼Œæ²¡æœ‰è€ƒè™‘åˆ°è½¬ä¹‰å­—ç¬¦

### 3.2.3 è¯­æ³•åˆ†æå®Œæˆåçš„æ”¹åŠ¨

- æœ€å¤§çš„æ”¹åŠ¨æ˜¯ï¼Œç”±è®¾è®¡ä¹‹åˆçš„ä¸€éæ‰«ææ”¹ä¸ºå¤šéæ‰«æ
  - åœ¨è¯æ³•åˆ†ææ—¶ï¼Œè®¾è®¡é‡‡ç”¨ä¸€éæ‰«æï¼Œå³è¯­æ³•åˆ†æä¸­æ¯æ¬¡è°ƒç”¨è¯æ³•åˆ†æçš„æ¥å£`getToken()`å³è¿”å›ä¸‹ä¸€ä¸ªtokenã€‚
    åœ¨è¯æ³•åˆ†æç¨‹åºå†…éƒ¨ä¸­ä½¿ç”¨`BufferedReader`çš„`mark()`å’Œ`reset()`ä¸¤ä¸ªæ–¹æ³•ç»„å®ç°å­—ç¬¦è¯»å–çš„å›é€€ï¼Œåœ¨è¯­æ³•åˆ†æå¼€å§‹æ—¶è®¡åˆ’åœ¨è°ƒç”¨`getToken()`æ¥å£çš„å¤–å±‚ä¹Ÿä½¿ç”¨è¿™ä¸¤ä¸ªæ–¹æ³•å®ç°tokençš„å›é€€å’Œé¢„è¯»ã€‚
  - ä½†æ˜¯è¿™æ ·ä¼šä½¿å¾—åœ¨æ¥å£å†…éƒ¨å†æ¬¡è°ƒç”¨`mark()`è¦†ç›–å¤–å±‚çš„`mark()`ä½¿å¾—æ— æ³•å›é€€tokenç­‰é—®é¢˜ï¼Œå› æ­¤æ”¹ä¸ºå¤šéæ‰«æï¼Œå³åœ¨è¯­æ³•åˆ†æå‰å…ˆå®Œæˆæ•´ä¸ªç¨‹åºçš„è¯æ³•åˆ†æå¾—åˆ°tokenåºåˆ—ï¼Œæ¥ä¸‹æ¥çš„è¯­æ³•åˆ†æä¾¿ä¸ç”¨é€šè¿‡æ“ä½œè¯»å–å™¨å›é€€tokenï¼ŒåŠŸèƒ½å®Œæˆè§£è€¦ã€‚
- ä¿®æ”¹äº†è¯æ³•åˆ†æè§£æå¤šè¡Œæ³¨é‡Šçš„éƒ¨åˆ†ï¼šåœ¨deå®Œè¯­æ³•åˆ†æçš„bugåï¼Œå…¬å…±æµ‹è¯•åº“å…¨è¿‡ä½†æµ‹è¯•ç‚¹16REï¼Œæœ€åå‘ç°æ˜¯è¯æ³•åˆ†æä¸­å¯¹å¤šè¡Œæ³¨é‡Šçš„è¯»å–æœ‰è¯¯

# 4 è¯­æ³•åˆ†æè®¾è®¡

## 4.1 ç¼–ç å‰çš„è®¾è®¡

- ä¸è¯æ³•åˆ†æç±»ä¼¼ï¼Œä½¿ç”¨å•ä¾‹æ¨¡å¼å®ç°`Parser.java`
- ä¸»è¦é‡‡ç”¨é€’å½’ä¸‹é™ç¨‹åºå®ç°
- æ­¤å¤–é€šè¿‡é¢„è¯»è§£å†³å¤šä¸ªè§„åˆ™åŒ¹é…é—®é¢˜

ä»¥ä¸‹æ˜¯ç¼–å†™é€’å½’ç¨‹åºæ—¶çš„è¾…åŠ©è¡¨æ ¼ï¼Œéƒ¨åˆ†éç»ˆç»“ç¬¦çš„FIRSTç•¥

| éç»ˆç»“ç¬¦     | FIRSTé›†                                          | å®Œæˆ |
| ------------ | ------------------------------------------------ | ---- |
| CompUnit     | CONSTTK, INTTK, CHARTK, VOIDTK                   | V    |
| Decl         | CONSTTK, INTTK, CHARTK                           | V    |
| FuncDef      | VOIDTK, INTTK, CHARTK                            | V    |
| MainFuncDef  | INTTK                                            | V    |
| ConstDecl    | CONSTTK                                          | V    |
| VarDecl      | INT, CHAR                                        | V    |
| FuncType     | 'VOIDTK, INTTK, CHARTK                           | V    |
| BType        | INTTK, CHARTK                                    | V    |
| ConstDef     |                                                  | V    |
| Ident        | Vt                                               | V    |
| ConstInitVal |                                                  | V    |
| ConstExp     |                                                  | V    |
| StringConst  | Vt                                               | V    |
| AddExp       |                                                  | V    |
| MulExp       |                                                  | V    |
| UnaryExp     | LPARENT, IDENFR, INTCON, CHRCON, PLUS, MINU, NOT | V    |
| PrimaryExp   | LPARENT, IDENFR, INTCON, CHRCON                  | V    |
| FuncRParams  |                                                  | V    |
| UnaryOp      | PLUS, MINU, NOT                                  | V    |
| LVal         | IDENFR                                           | V    |
| Number       | INTCON                                           | V    |
| Character    | CHRCON                                           | V    |
| IntConst     | Vt                                               | V    |
| CharConst    | Vt                                               | V    |
| VarDef       |                                                  | V    |
| InitVal      |                                                  | V    |
| Exp          | LPARENT, IDENFR, INTCON, CHRCON, PLUS, MINU, NOT | V    |
| FuncFParams  | INTTK, CHARTK                                    | V    |
| FuncFParam   | INTTK, CHARTK                                    | V    |
| Block        | LPARENT                                          | V    |
| BlockItem    |                                                  | V    |
| Stmt         |                                                  | V    |
| ForStmt      |                                                  | V    |
| Cond         |                                                  | V    |
| LOrExp       |                                                  | V    |
| LAndExp      |                                                  | V    |
| EqExp        |                                                  | V    |
| RelExp       |                                                  | V    |

## 4.2 ç¼–ç åçš„è®¾è®¡

### 4.2.1 è®¾è®¡æ¨¡å¼

- è¯­æ³•åˆ†æå™¨`Parser.java`ä¸è¯æ³•åˆ†æå™¨ç±»ä¼¼ï¼Œé‡‡ç”¨é¥¿æ±‰å¼å•ä¾‹æ¨¡å¼ï¼›
- å•ä¾‹æ¨¡å¼çš„é™æ€æ–¹æ³•ä¸éé™æ€æ–¹æ³•çš„å®ç°æ•ˆæœç±»ä¼¼ï¼Œä½†ä¸ºäº†ç®€ä¾¿ï¼Œåœ¨è¯­æ³•æˆåˆ†ç±»ä¸­è¦é¢‘ç¹è°ƒç”¨çš„`getSymbol() currentSymbol()`ç­‰æ–¹æ³•è®¾ç½®ä¸ºé™æ€æ–¹æ³•ã€‚

### 4.2.2 é€’å½’ä¸‹é™è¯»å–é€»è¾‘

- åœ¨ä¸€ä¸ªç¨‹åºè¦è°ƒç”¨ä¸€ä¸ªåˆ†æå­ç¨‹åºå‰ï¼Œéœ€è¦ä½¿ç”¨`Parser.getSymbol()`è¯»å–ä¸€ä¸ªtoken
- åœ¨åˆ†æå­ç¨‹åºé‡Œï¼Œåˆ†æå­ç¨‹åºä¼šé€’å½’åŒ¹é…æ‰€æœ‰tokenï¼Œä½†å¹¶ä¸ä¼šè¶…å‰è¯»å–ï¼ˆä¾‹å¦‚åˆ†æå­ç¨‹åºåªåŒ¹é…ä¸€ä¸ªç»ˆç»“ç¬¦å³ç»“æŸï¼Œåˆ™ä¸ä¼šè°ƒç”¨`Parser.getSymbol()`ï¼‰ï¼Œå› æ­¤ä¸€ä¸ªå­æˆåˆ†åˆ†æå®Œåï¼Œ`symbol`åœç•™åœ¨æœ€ååŒ¹é…åˆ°çš„é‚£ä¸ªtokenå¤„
- æ¥ç€ç»§ç»­ä½¿ç”¨`Parser.getSymbol()`è¯»å–ä¸€ä¸ªtokenå¹¶è°ƒç”¨å‰©ä¸‹çš„åˆ†æå­ç¨‹åº
- åœ¨é‡åˆ°ç»ˆç»“ç¬¦æ—¶ï¼ŒåŒ¹é…åä¸éœ€è¦ä½¿ç”¨`Parser.getSymbol()`ï¼Œå› ä¸ºé€’å½’è¿‡ç¨‹ç›¸å½“äºåœ¨åŒ¹é…ä¹‹å‰å·²ç»æ‰§è¡Œä¸€æ¬¡

### 4.2.3 ç±»è®¾è®¡

- å¯¹äºè¯­æ³•æ ‘çš„æ„å»ºï¼Œé¦–å…ˆè®¾è®¡äº†ä¸€ä¸ªè¯­æ³•æ ‘èŠ‚ç‚¹çš„æ¥å£`SyntaxNode.java`ï¼š

  ```java
  public interface SyntaxNode<T> {
      public T parse() throws IOException;
  
      public String outputString();
  }
  ```

- å¯¹äºæ¯ä¸ªè¯­æ³•æˆåˆ†ï¼Œå‡è®¾è®¡åŒåçš„ä¸€ä¸ªç±»å¹¶å®ç°ä»¥ä¸Šæ¥å£ï¼›

  - å¯¹äºè¯¥è¯­æ³•æˆåˆ†çš„ä¸€æ¡è§„åˆ™ï¼Œè§„åˆ™å³éƒ¨è¯­æ³•æˆåˆ†ä½œä¸ºè¯¥ç±»çš„ä¸€ä¸ªå±æ€§å­˜å‚¨
    - è‹¥æœ‰å¤šæ¡è§„åˆ™ï¼Œåˆ™æ ¹æ®FIRSTé›†çš„ä¸åŒåˆ’åˆ†æˆä¸åŒçš„å­ç±»ï¼Œè¶…ç±»å±æ€§ç±»å‹ä¸ºè¶…ç±»ï¼Œä½†åœ¨`parse()`æ–¹æ³•ä¸­æ ¹æ®å½“å‰ç¬¦å·é€‰æ‹©å®ä¾‹åŒ–ä¸åŒçš„å­ç±»ï¼ˆæ–¹æ³•é‡å†™å’Œå¤šæ€ï¼‰
    - è‹¥å³éƒ¨è¯­æ³•æˆåˆ†å¯é‡å¤å¤šæ¬¡ï¼Œåˆ™å­˜å‚¨å¯¹åº”çš„åˆ—è¡¨
    - è‹¥å³éƒ¨è¯­æ³•æˆåˆ†å¯é€‰ï¼Œåˆ™å€¼é`null`æ—¶è¡¨ç¤ºå­˜åœ¨ï¼Œå¦åˆ™ä¸å­˜åœ¨
  - ç±»çš„`parse()`æ–¹æ³•ä¼šæ ¹æ®è¯­æ³•åˆ†æå™¨å½“å‰è§£æåˆ°çš„ç¬¦å·`Parser.currentSymbol()`å‘å‰è§£æï¼Œå¹¶è¿”å›è‡ªèº«ï¼ˆ`return this`ï¼‰
  - é¡¶å±‚è¯­æ³•æˆåˆ†è°ƒç”¨`parse()`æ–¹æ³•è§£ææ—¶ï¼Œä¸ºä¸‹å±‚è¯­æ³•æˆåˆ†å±æ€§èµ‹å€¼ä¸€ä¸ªè°ƒç”¨è¿‡è‡ªèº«`parse()`æ–¹æ³•çš„`new`å¯¹è±¡ï¼Œè¿™æ ·å°±å®ç°äº†é€’å½’
  - æ¯ä¸ªè¯­æ³•æˆåˆ†çš„`outputString()`æ–¹æ³•æŒ‰ç…§åŒæ ·çš„é€’å½’é€»è¾‘è¿”å›éœ€è¦è¾“å‡ºçš„å†…å®¹å’Œæ ¼å¼

- ä¸ºäº†ä½¿å¾—ç»“æ„æ¸…æ™°ï¼ŒæŒ‰åŠŸèƒ½å°†è¯­æ³•æˆåˆ†åŒ…ä¸º`declaration`, `expression`, `function`, `statement`, `terminal`äº”ä¸ªåŒ…

- å¯¹äºæœ‰å¤šæ¡è§„åˆ™çš„è¯­æ³•æˆåˆ†çš„å­ç±»ä¹Ÿåˆ†åŒ…ç®¡ç†ï¼Œå¦‚`stmts`, `unaryexps`, `primaryexps`

### 4.2.4 FIRSTé›†å†²çªè§£å†³æ–¹æ¡ˆ

- è‹¥FIRSTé›†å†²çªï¼Œå¯ä»¥ç±»ä¼¼çš„æŸ¥çœ‹è§„åˆ™çš„SECONDé›†ï¼Œå¹¶ä½¿ç”¨`preReadNext()`é¢„è¯»ä¸€ä¸ªtokençš„æ–¹æ³•åŒºåˆ†ï¼ˆå¤§éƒ¨åˆ†å¯ä»¥è§£å†³ï¼‰
- ä»…åœ¨`CompUnit->Decl|FuncDef`ï¼ŒSECONDé›†ä»å†²çªï¼Œåˆ™`preReadNextNext()`é¢„è¯»ä¸‹ä¸‹ä¸ªtokenå¯ä»¥åŒºåˆ†
- ä»…åœ¨`Stmt`çš„æ¨å¯¼æ—¶ï¼Œä½¿ç”¨SECONDé›†ä»ç„¶éš¾ä»¥åŒºåˆ†ï¼Œæ­¤å¤„é‡‡ç”¨å›æº¯tokençš„æ–¹æ³•è§£å†³
  - åœ¨å›æº¯æ—¶éœ€è¦åŒæ—¶å›æº¯æŠ›å‡ºçš„é”™è¯¯ï¼ä¸ç„¶ä¼šå‡ºç°å¤šè¾“å‡ºé”™è¯¯çš„æƒ…å†µ


### 4.2.5 å·¦é€’å½’æ–‡æ³•è§£å†³æ–¹æ¡ˆ

- å¯¹äºå·¦é€’å½’æ–‡æ³•ï¼Œå°†è§„åˆ™æ”¹å†™ä¸ºæ‰©å……çš„BNFèŒƒå¼ã€‚
  ä»¥`MulExp â†’ UnaryExp | MulExp ('*' | '/' | '%') UnaryExp`è¿™æ¡è§„åˆ™ä¸ºä¾‹ï¼Œæ¶ˆé™¤å·¦é€’å½’åå¾—åˆ°
  `MulExp â†’ UnaryExp { ('*' | '/' | '%') UnaryExp }`

- ä»¥è¿™æ¡è§„åˆ™ä¸ºä¾‹ï¼Œè¿™äº›å…·æœ‰é€’å½’æ–‡æ³•çš„ç±»å±æ€§è®¾ç½®ä¸ºä¸€ä¸ª`UnaryExp`ç±»å’Œä¸€ä¸ªå…ƒç´ ä¸º`OpUnaryExp`ç±»çš„åˆ—è¡¨åˆ†åˆ«è¡¨ç¤ºEBNFèŒƒå¼çš„ä¸¤éƒ¨åˆ†

- å…¶ä¸­`OpUnaryExp`ä¸ºé™æ€å†…éƒ¨ç±»ï¼Œç›¸å½“äºä¸€ä¸ªäºŒå…ƒç»„ï¼ŒåŒ…å«æ¯ä¸ªé‡å¤çš„ç¬¦å·`op`å’Œ`unaryExp`

- è‡³æ­¤ä¾¿æ¶ˆé™¤å·¦é€’å½’æ–‡æ³•ï¼Œåœ¨åˆ†ææ–¹æ³•ä¸­ä¸ä¼šé€’å½’è°ƒç”¨è‡ªå·±ï¼Œè€Œæ˜¯ä¸æ–­è°ƒç”¨ä¸‹ä¸€å±‚çš„è¯­æ³•æˆåˆ†åˆ†ææ–¹æ³•ï¼›å¹¶ä¸”åœ¨è¾“å‡ºæ–¹æ³•`outputString()`ä¸­ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç±»ä¼¼é€»è¾‘è¾“å‡ºæ­£ç¡®çš„è¯­æ³•æ ‘ç»“æ„

- ä»`UnaryExp->MulExp->AddExp->RelExp->EqExp->LAndExp->LorExp`å„å±‚æ¬¡é—´å…³ç³»æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œå› æ­¤ç¼–å†™å®Œ`UnaryExp->MulExp`åï¼Œå¯é€šè¿‡ä»£ç æŸ¥æ‰¾æ›¿æ¢è¿ç§»å¾—åˆ°åé¢çš„å±‚é—´å…³ç³»ï¼›æ‰‹ç¨¿å¦‚ä¸‹ï¼š

  ![07fae8c98c7d24c7990122f1fc798d0](https://cdn.jsdelivr.net/gh/bush-cn/TyporaImages@main/img/2025/07/11/20250711101500.jpg)

### 4.2.6 å…³äºé”™è¯¯å¤„ç†çš„ä¿®æ”¹

- åœ¨ä¹‹å‰çš„è¯æ³•åˆ†æè®¾è®¡æ—¶ï¼Œè®¾è®¡äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„`CompileError`å¹¶ç»§æ‰¿`Exception`ç±»ï¼Œé”™è¯¯é€šè¿‡throwæŠ›å‡ºè‡ª`CompileError`æŠ¥é”™å¹¶åœ¨ä¸Šå±‚å¤„ç†ï¼Œä½†åœ¨æ­¤æ¬¡ç¼–ç æ—¶å‘ç°ï¼š

  - è¯­æ³•åˆ†æä¸è¯æ³•åˆ†æä¸åŒï¼Œè¯æ³•åˆ†ææ˜¯é¡ºåºæ‰§è¡Œï¼Œå¯ä»¥ä½¿ç”¨throwæŠ›å‡ºå¼‚å¸¸ï¼Œåœ¨é¡¶å±‚è®°å½•é”™è¯¯å¹¶ç»§ç»­æ‰§è¡Œ 
  - è€Œè¯­æ³•åˆ†ææ˜¯é€’å½’è°ƒç”¨çš„ï¼Œä¸èƒ½å¤Ÿè¢«ä¸­æ–­ï¼Œå› æ­¤æŠŠé”™è¯¯æš‚å­˜è€Œä¸æ˜¯æŠ›å‡º

- å¹¶ä¸”ç”±ä¸€éæ‰«ææ”¹ä¸ºå¤šéæ‰«æä¹Ÿä¸èƒ½é¡ºåºåœ°ä¾æ¬¡å¤„ç†é”™è¯¯ã€‚å› æ­¤ï¼Œä¿®æ”¹å¤„ç†é€»è¾‘ï¼Œå°†æ‰€æœ‰é”™è¯¯å…ˆæš‚å­˜å¹¶ç›´æ¥å¤„ç†ï¼Œæœ€åä¸€èµ·è¾“å‡ºã€‚
- éœ€è¦æ³¨æ„çš„æ˜¯ä¸€éæ‰«æé”™è¯¯æŠ›å‡ºçš„é¡ºåºæ˜¯æŒ‰è¡Œæ•°å‡åºçš„ï¼Œä½†å¤šéæ‰«æçš„é¡ºåºä¸€æ¬¡æ˜¯è¯æ³•åˆ†æé”™è¯¯ã€è¯­æ³•åˆ†æé”™è¯¯ã€è¯­ä¹‰åˆ†æé”™è¯¯ç­‰ï¼Œéœ€è¦åœ¨è¾“å‡ºå‰æŒ‰è¡Œæ•°æ’åºå†è¾“å‡º

# 5 è¯­ä¹‰åˆ†æè®¾è®¡

## 5.1 ç¼–ç å‰çš„è®¾è®¡

åœ¨è¿™ä¸€é˜¶æ®µï¼Œä¸éœ€è¦è¿›è¡Œä¸­é—´ä»£ç ç”Ÿæˆï¼Œåªéœ€è¦è¾“å‡ºç¬¦å·è¡¨å†…å®¹ã€‚ä¸”æŒ‡å¯¼ä¹¦åœ¨ä¸­é—´ä»£ç ç”Ÿæˆè¿™ä¸€ç« å†™é“ï¼š

> å¯¹äºç¬¦å·è¡¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¯ä»¥æ˜¯éå† AST åï¼Œç”Ÿæˆä¸€å¼ **å®Œæ•´çš„ç¬¦å·è¡¨**ï¼Œç„¶åå†è¿›è¡Œä»£ç ç”Ÿæˆï¼›ä¹Ÿå¯ä»¥æ˜¯åœ¨éå†è¿‡ç¨‹ä¸­åˆ›å»º**æ ˆå¼ç¬¦å·è¡¨**ï¼Œéšç€éå†è¿‡ç¨‹åˆ›å»ºå’Œé”€æ¯ï¼ŒåŒæ—¶è¿›è¡Œä»£ç ç”Ÿæˆã€‚

å› æ­¤ï¼Œæš‚æ—¶è®¾è®¡ä¸ºå…ˆéå†ASTç”Ÿæˆæ ‘å½¢ç¬¦å·è¡¨ï¼Œå†åœ¨åé¢çš„ä¸­é—´ä»£ç ç”Ÿæˆæ—¶åšå¢é‡å¼å¼€å‘ã€‚

---

é‡‡ç”¨è®¿é—®è€…æ¨¡å¼ï¼š

- è®¾è®¡ä¸€ä¸ªå•ä¾‹`Visitor`ç±»ï¼Œå…¶åŒ…å«ä¸åŒè¯­æ³•æˆåˆ†çš„`visit()`æ–¹æ³•ï¼Œè§£æè¯­æ³•æ ‘å¹¶è°ƒç”¨ä¸‹å±‚çš„`visit()`æ–¹æ³•ã€‚
- ä»…`visit(CompUnit compUnit)`æ–¹æ³•ä¸º`public`ä»¥ä¾¿å¤–å±‚è°ƒç”¨ï¼Œå…¶ä½™è¯­æ³•æˆåˆ†çš„`visit()`æ–¹æ³•è®¾ç½®ä¸º`private`è¢«å…¶è°ƒç”¨ã€‚

## 5.2 ç¼–ç åçš„è®¾è®¡

### 5.2.1 ç¬¦å·å’Œç¬¦å·è¡¨çš„ç±»è®¾è®¡

- ç¬¦å·ç±»`Symbol`è®¾ç½®ä¸ºæŠ½è±¡ç±»ï¼š`ConstInt, ConstChar, ConstIntArray, ConstCharArray, ConstInt, ConstChar, ConstIntArray, ConstCharArray`è¿™8ç§ç¬¦å·æ¯ç§å„è®¾ç½®ä¸€ä¸ªå­ç±»`xxxSymbol`ç»§æ‰¿`Symbol`ï¼›`IntFunc, CharFunc, VoidFunc`è¿™3ç§ç¬¦å·è®¾è®¡ä¸€ä¸ªå­ç±»`FuncSymbol`ï¼›å…±9ä¸ªç»§æ‰¿ã€‚

- ç¬¦å·è¡¨éœ€è¦ç»´æŒæ ‘çŠ¶ç»“æ„ï¼Œå› æ­¤æ·»åŠ `fatherTable`è¿™ä¸€å±æ€§ã€‚æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š

  ```java
  public SymbolTable(SymbolTable fatherTable) {
      this.fatherTable = fatherTable;
      this.scopeId = scopeIdCounter++;
      fatherTable.childrenTables.add(this);
  }
  private SymbolTable() {
      this.fatherTable = null;
      this.scopeId = scopeIdCounter++;
  }
  ```

  å…¶ä¸­æ ¹ç¬¦å·è¡¨ä½œä¸ºé™æ€å±æ€§å­˜å‚¨ä»¥ä¾¿è¾“å‡ºï¼š

  ```java
  public static final SymbolTable ROOT = new SymbolTable(); // æ ¹ç¬¦å·è¡¨ï¼Œå³å…¨å±€ç¬¦å·è¡¨
  ```

### 5.2.2 è®¿é—®è€…è®¾è®¡

- è®¿é—®è€…æ€»ä½“ç»“æ„ä¸ #5.1 ç¼–ç å‰çš„è®¾è®¡ç›¸åŒï¼›
- åœ¨è®¿é—®è€…ä¸­ç»´æŠ¤ä¸€ä¸ª`curSymbolTab`å±æ€§ä¿å­˜å½“å‰çš„ç¬¦å·è¡¨ï¼›
- å¦æœ‰å…¶ä»–å±æ€§ç”¨æ¥è¾…åŠ©è¯­ä¹‰åˆ†æï¼ˆç›´æ¥ä½œä¸ºVisitorå±æ€§å°±ä¸ç”¨åœ¨æ–¹æ³•ä¸­ä¼ é€’å‚æ•°äº†ï¼‰ã€‚

### 5.2.3 è¯­ä¹‰åˆ†æåçš„æ”¹åŠ¨

- è§£è€¦è¯æ³•åˆ†æå™¨å’Œè¯­æ³•åˆ†æå™¨ï¼Œä¼˜åŒ–äº†å¯¹å¤–æ¥å£
- ä¸ºè¯­æ³•æˆåˆ†å±æ€§æ·»åŠ Getter
- UnaryExp â†’ UnaryOp UnaryExpè¿™æ¡è§„åˆ™ä¸åº”æ‹†åˆ†å­ç±»è€Œåº”æŠŠUnaryOpä½œä¸ºUnaryExpçš„å±æ€§
- é‡æ„å¤šæ¡è§„åˆ™è¯­æ³•æˆåˆ†ï¼šå°†Stmtã€BlockItemã€PrimaryExpä¸­çš„è‡ªåå±æ€§åˆ å»ï¼›å°†UnaryExpä¸­çš„å±æ€§æ›´åä¸ºUnaryExpWithoutOpã€‚è¿™æ ·é¿å…äº†åœ¨è¯­ä¹‰åˆ†ææ—¶ï¼Œä½¿ç”¨`unaryExp.getUnaryExp(), primaryExp.getPrimaryExp(), stmt.getStmt() instanceof ReturnStmt`ç­‰ç­‰å†—ä½™ä¸”æ˜“å‡ºé”™çš„è°ƒç”¨ã€‚

### 5.2.4 å®Œæˆåçš„æ€è€ƒ

ç›¸æ¯”äºè¯­æ³•åˆ†æï¼Œè¿™æ¬¡çš„ä¸»è¦ä»£ç å‡åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸‹ï¼ˆ`Visitor.java`ï¼‰ï¼Œè€¦åˆåº¦é«˜ã€æ¨¡å—åŒ–å·®ã€éš¾ä»¥é˜…è¯»å’Œè°ƒè¯•ã€‚ä½†ç”±äºè¿™æ¬¡åªæ˜¯éƒ¨åˆ†çš„è¯­ä¹‰åˆ†æï¼Œä¸æ¶‰åŠä¸­é—´ä»£ç ç”Ÿæˆï¼Œå› æ­¤æœŸå¾…åœ¨åé¢çš„è¿­ä»£ä¸­ä¼˜åŒ–ç»“æ„ã€è§£è€¦åˆã€‚

# 6 ä»£ç ç”Ÿæˆè®¾è®¡

## 6.1 ç¼–ç å‰çš„è®¾è®¡

### 6.1.1 ä¸­é—´ä»£ç ç”Ÿæˆè®¾è®¡

æŒ‰ç…§æ•™ç¨‹çš„æ„å»ºå•å…ƒè®¾ç½®ç›¸å…³ç±»ï¼š

<img src="https://cdn.jsdelivr.net/gh/bush-cn/TyporaImages@main/img/2025/07/11/20250711101617.png" alt="img" style="zoom:50%;" />

ç±»é‡Œå‡å­˜æ”¾åˆå§‹åŒ–çš„å€¼ï¼Œä»…ä»…ç”¨äºè½¬æˆLLVM IRæ–‡æœ¬ã€‚å®é™…è¦è¾“å‡ºå¸¸é‡çš„å€¼åº”å·®ç¬¦å·è¡¨ã€‚

æŒ‡ä»¤ï¼š

| LLVM IR         | ä½¿ç”¨æ–¹æ³•                                                     | ç®€ä»‹                                                         |
| --------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| `add`           | `<result> = add <ty> <op1>, <op2>`                           | /                                                            |
| `sub`           | `<result> = sub <ty> <op1>, <op2>`                           | /                                                            |
| `mul`           | `<result> = mul <ty> <op1>, <op2>`                           | /                                                            |
| `sdiv`          | `<result> = sdiv <ty> <op1>, <op2>`                          | æœ‰ç¬¦å·é™¤æ³•                                                   |
| `srem`          | `<result> = srem <baseType> <op1>, <op2>`                    | æœ‰ç¬¦å·å–ä½™                                                   |
| `icmp`          | `<result> = icmp <cond> <ty> <op1>, <op2>`                   | æ¯”è¾ƒæŒ‡ä»¤                                                     |
| `and`           | `<result> = and <ty> <op1>, <op2>`                           | æŒ‰ä½ä¸                                                       |
| `or`            | `<result> = or <ty> <op1>, <op2>`                            | æŒ‰ä½æˆ–                                                       |
| `call`          | `<result> = call [ret attrs] <ty> <name>(<...args>)`         | å‡½æ•°è°ƒç”¨                                                     |
| `alloca`        | `<result> = alloca <baseType>`                               | åˆ†é…å†…å­˜                                                     |
| `load`          | `<result> = load <ty>, ptr <pointer>`                        | è¯»å–å†…å­˜                                                     |
| `store`         | `store <ty> <initValue>, ptr <pointer>`                      | å†™å†…å­˜                                                       |
| `getelementptr` | `<result> = getelementptr <ty>, ptr <ptrval>{, <ty> <idx>}*` | è®¡ç®—ç›®æ ‡å…ƒç´ çš„ä½ç½®ï¼ˆæ•°ç»„éƒ¨åˆ†ä¼šå•ç‹¬è¯¦ç»†è¯´æ˜ï¼‰                 |
| `phi`           | `<result> = phi [fast-math-flags] <ty> [<val0>, <label0>], ...` | /                                                            |
| `zext..to`      | `<result> = zext <ty> <initValue> to <ty2>`                  | å°† `ty` çš„ `initValue` çš„ baseType æ‰©å……ä¸º `ty2`ï¼ˆzero extendï¼‰ |
| `trunc..to`     | `<result> = trunc <ty> <initValue> to <ty2>`                 | å°† `ty` çš„ `initValue` çš„ baseType ç¼©å‡ä¸º `ty2`ï¼ˆtruncateï¼‰  |
| `br`            | `br i1 <cond>, label <iftrue>, label <iffalse>` `br label <dest>` | æ”¹å˜æ§åˆ¶æµ                                                   |
| `ret`           | `ret <baseType> <initValue> `, `ret void`                    | é€€å‡ºå½“å‰å‡½æ•°ï¼Œå¹¶è¿”å›å€¼                                       |

- åœ¨ç”Ÿæˆå¯¹åº”æŒ‡ä»¤æ—¶ï¼Œå°†slotåŠ å…¥å‡½æ•°åŸŸã€‚ä¾‹å¦‚åœ¨`visitAddExp`ä¸­ï¼Œä»…åœ¨åœ¨ç”ŸæˆaddæŒ‡ä»¤æ—¶å°†resultä½œä¸ºæ–°slotåŠ å…¥å‡½æ•°åŸŸï¼Œå…¶ä»–slotå‡åœ¨è°ƒç”¨çš„`visitMulExp`ä¸­å·²åŠ å…¥å‡½æ•°åŸŸã€‚
- ç¬¦å·ç±»ä¸­æ–°å¢addresså­—æ®µï¼Œå­˜æ”¾ç¬¦å·åˆ†é…åˆ°çš„åœ°å€ç©ºé—´
- æˆ‘ä»¬è§„å®šæ•°ç»„ååªç”¨æ¥ï¼ˆ1ï¼‰å‡½æ•°ä¼ å‚ï¼ˆæ­¤æ—¶åº”ç”±FuncRParamä¸€è·¯æ¨å¯¼è‡³Identï¼Œä¸å­˜åœ¨ä»»ä½•å…¶ä»–ç¬¦å·ï¼‰ï¼Œï¼ˆ2ï¼‰é€šè¿‡ç´¢å¼•å–æ•°ç»„é‡Œé¢çš„å€¼ã€‚

|          | å…¨å±€ä½œç”¨åŸŸ                                               | å±€éƒ¨ä½œç”¨åŸŸ                                            | å…±æ€§                                                         |
| -------- | -------------------------------------------------------- | ----------------------------------------------------- | ------------------------------------------------------------ |
| **å¸¸é‡** |                                                          |                                                       | å•ä¸ªå¸¸é‡å’Œå¸¸é‡æ•°ç»„å‡éœ€ç»™å®š`ConstExp`ï¼ˆå³å¯åœ¨ç¼–è¯‘æ—¶è®¡ç®—çš„ï¼‰åˆå§‹å€¼ |
| **å˜é‡** | è‹¥æœ‰åˆå§‹å€¼ï¼Œåˆ™å¿…é¡»æ˜¯å¯è®¡ç®—çš„`ConstExp`ï¼›è‹¥æ— åˆå§‹å€¼ï¼Œç½®é›¶ | å¯ä»¥æ˜¯ä¸å¯è®¡ç®—çš„`Exp`                                 | å¯ä»¥ä¸å¸¦åˆå§‹å€¼                                               |
| å…±æ€§     | @å£°æ˜ï¼Œåœ¨é¡¶å±‚ï¼Œå±äº`GlobalValue`ï¼›éœ€è¦ä¿å­˜åˆå§‹å€¼         | å¸¸é‡å’Œå˜é‡jun`alloca`æŒ‡ä»¤å£°æ˜ï¼Œä»…ä¿å­˜å¯¹åº”çš„è™šæ‹Ÿå¯„å­˜å™¨ |                                                              |

- ä¸€ä¸ªifè¯­å¥å°†å½“å‰åŸºæœ¬å—åˆ†ä¸º4ä¸ªåŸºæœ¬å—ï¼ˆæœ‰elseï¼‰æˆ–3ä¸ªåŸºæœ¬å—ï¼ˆæ— elseï¼‰

- ä¸€ä¸ªforè¯­å¥å°†å½“å‰åŸºæœ¬å—åˆ†ä¸º5å—

  | B1   | preForStmtï¼ˆè‹¥æ— preForStmtï¼Œåˆ™æ— B1ï¼‰                   |
  | ---- | ------------------------------------------------------ |
  | B2   | Condï¼Œæ¡ä»¶è·³è½¬æŒ‡ä»¤B3ã€B5ï¼ˆè‹¥æ— Condï¼Œåˆ™æ˜¯æ— æ¡ä»¶è·³è½¬B3ï¼‰ |
  | B3   | Stmtï¼Œæ— æ¡ä»¶è·³è½¬B4                                     |
  | B4   | postStmtï¼Œæ— æ¡ä»¶è·³è½¬B2 ï¼ˆ**continueè¯­å¥è·³ç‚¹**ï¼‰        |
  | B5   | ï¼ˆendï¼‰ï¼ˆ**breakè¯­å¥è·³ç‚¹**ï¼‰                           |

- æš‚æ—¶ä¸è€ƒè™‘SSAå½¢å¼å’ŒphiæŒ‡ä»¤ï¼Œç¬¦å·è¡¨å­˜å‚¨åœ°å€ï¼Œæ¯æ¬¡å¼•ç”¨å˜é‡ä½¿ç”¨loadï¼Œèµ‹å€¼å˜é‡ä½¿ç”¨storeã€‚

- å‡½æ•°ä¼ é€’çš„éæŒ‡é’ˆå‚æ•°ä¸èƒ½ä¿®æ”¹ï¼Œå› æ­¤**åœ¨è¿›å…¥å‡½æ•°æ—¶**ï¼Œéœ€è¦ä¸ºå…¶allocaä¸€ä¸ªåœ°å€ç©ºé—´ï¼Œå¹¶å°†ä¼ è¿›çš„å‚æ•°èµ‹ç»™å®ƒï¼ˆç›¸å½“äºå˜é‡å®šä¹‰ï¼‰ã€‚**ä¸èƒ½åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶å†åˆ†é…å¹¶èµ‹å€¼**ï¼Œå› ä¸ºå¦‚æœåœ¨å¾ªç¯ä½“å†…ä½¿ç”¨è¯¥å˜é‡ï¼Œåˆ™ä¼šå¯¼è‡´æ­»å¾ªç¯ï¼š

```c
int fun2(int a)  // a=6
{
    int b = 1;
    int num = 1;
    for (;a >= 1;)		 // ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶
    {
        b = b * a;
        a = a - 1;		
        if (a == 1)
        {
            break;
        }
        else if (a != 1)
        {
            num = num + 1;
        }
    }
    printf("a! = %d, num = %d\n", b, num);
    return 1;
}
```

```assembly
define dso_local i32 @fun2(i32 %0) {
1:
	%2 = alloca i32
	store i32 1, i32* %2
	%3 = alloca i32
	store i32 1, i32* %3
	br label %4
4:
	%5 = icmp sge i32 %0, 1			; forå¾ªç¯çš„condå—ã€‚è‹¥ä¸åˆ†é…ï¼Œè¿™é‡Œä¼šå§‹ç»ˆä¼šç”¨açš„æ—§å€¼ï¼›è€Œå¦‚æœåœ¨æ­¤åˆ†é…å¹¶èµ‹å€¼ï¼Œåˆ™ä¼šä¸€ç›´èµ‹ç›¸åŒçš„å€¼ç»™a
	%6 = zext i1 %5 to i32
	%7 = icmp ne i32 %6, 0
	br i1 %7, label %8, label %26
```



### 6.1.2 åç«¯ä»£ç ç”Ÿæˆè®¾è®¡

- ä»¥å‡½æ•°ä¸ºå•ä½ç®¡ç†æ ˆå¸§ã€åˆ†é…å…¨å±€å¯„å­˜å™¨ï¼Œä»¥åŸºæœ¬å—ä¸ºå•ä½åˆ†é…ä¸´æ—¶å¯„å­˜å™¨ï¼ˆå¯„å­˜å™¨åˆ†é…å®ç°åœ¨æ–‡æ¡£çš„ä¼˜åŒ–éƒ¨åˆ†ï¼‰

- åœ¨LLVM IRä¸­ï¼Œå­˜åœ¨i32å’Œi8ä¸¤ç§ç±»å‹ï¼Œä½†æ˜¯åœ¨MIPSä¸­ï¼Œå‡ä½¿ç”¨32ä½å­—å­˜å‚¨ã€‚

- æ ˆå¸§ç»“æ„ï¼ˆç®€åŒ–äº†éƒ¨åˆ†ç»“æ„ï¼‰

  ```
  /**
   * æ ˆå¸§ç»“æ„ï¼ˆä»é«˜åˆ°ä½å¢é•¿ï¼‰ï¼š
   * sp+size->|- - - - - - - |   ä»¥ä¸‹ä¸ºæ ˆå¸§å†…å®¹ï¼š
   *          |  å±€éƒ¨å˜é‡      |
   *          |- - - - - - - |   ä»¥ä¸‹è°ƒç”¨å‡½æ•°åéœ€ç”Ÿæˆçš„ï¼š
   *          |  è¿”å›åœ°å€      |
   *          |- - - - - - - |
   *          |  ï¼ˆä¿ç•™å¯„å­˜å™¨ï¼‰ |   ï¼ˆå³å…¨å±€å¯„å­˜å™¨s0-s7ï¼‰
   *          |- - - - - - - |
   *          |  è¢«è°ƒç”¨è€…å‚æ•°  |   ï¼ˆåŒ…æ‹¬a0-a3ã€‚ä»é«˜åˆ°ä½ï¼Œå…ˆå‹æœ€åä¸€ä¸ªå‚æ•°ï¼‰
   *  sp->    |- - - - - - - |
   */
  ```

  ![mips-stackframe](https://cdn.jsdelivr.net/gh/bush-cn/TyporaImages@main/img/2025/07/11/20250711101641.png)

- å‡½æ•°è°ƒç”¨è®¾è®¡ï¼š

  ```
  * ã€è°ƒç”¨è€…åŠ¨ä½œã€‘ï¼š
  *          1. ä¿å­˜raå¯„å­˜å™¨
  *          2. å°†åç»­éœ€è¦ç”¨åˆ°çš„ä¿ç•™å¯„å­˜å™¨å€¼å­˜å…¥æ ˆä¸­
  *          3. å°†å‚æ•°å‹æ ˆã€[å¦‚æœa0-a3æœ‰å†²çªï¼ˆéœ€è¦ä¼ é€’ä¸”åç»­è¦ç”¨åˆ°ï¼‰ï¼Œåˆ™éœ€è¦ä¿å­˜å¹¶æ¢å¤]
  *          4. æ›´æ”¹spå¯„å­˜å™¨çš„å€¼
  *          5. ä½¿ç”¨jalæŒ‡ä»¤
  *          6. å–v0è¿”å›å€¼å¹¶å¡«å…¥ç›¸åº”å¯„å­˜å™¨ï¼ˆè‹¥æœ‰è¿”å›å€¼ï¼‰
  *          7. å°†spå¯„å­˜å™¨çš„å€¼æ¢å¤
  *          8. æ¢å¤raå¯„å­˜å™¨å€¼ã€ä¿å­˜çš„å¯„å­˜å™¨å€¼ã€æ¢å¤å†²çªçš„a0-a3å¯„å­˜å™¨å€¼
  *          9. ç»§ç»­å…¶ä»–æŒ‡ä»¤â€¦â€¦
  *  ã€è¢«è°ƒç”¨è€…åŠ¨ä½œã€‘ï¼š
  *          1. æ‰§è¡Œå‡½æ•°é€»è¾‘ï¼Œè‹¥ä½¿ç”¨å‚æ•°åˆ™å–å¯„å­˜å™¨å€¼æˆ–æ ˆä¸Šå€¼
  *          2. æ‰§è¡Œåˆ°retæŒ‡ä»¤ï¼Œè¿”å›å€¼å­˜å…¥v0ï¼ˆè‹¥æœ‰ï¼‰
  *          3. ä½¿ç”¨jr raè¿”å›
  ```

  - éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºè¢«è°ƒç”¨è€…éœ€è¦é åç§»å–å‚æ•°ï¼Œæ‰€ä»¥åœ¨å°†å‚æ•°å‹æ ˆæ—¶ï¼Œåº”è¯¥ä¿è¯ä¸ä¼šå‡ºç°å¯„å­˜å™¨æº¢å‡ºçš„æƒ…å†µï¼Œå¦åˆ™ä¼šå¯¼è‡´åç§»ä¸å‚æ•°ä¸å¯¹åº”ã€‚

## 6.2 ç¼–ç åçš„è®¾è®¡

- éµå¾ª**é‡Œæ°æ›¿æ¢åŸåˆ™**å’Œ**å¼€æ”¾å°é—­åŸåˆ™**ï¼Œå°†LLVM IRå’ŒMIPSçš„æŒ‡ä»¤éƒ½è®¾ç½®ä¸ºä¸€ä¸ªæ¥å£æˆ–æŠ½è±¡ç±»ï¼Œå¹¶åœ¨å…·ä½“çš„æ¯æ¡æŒ‡ä»¤ä¸­é‡å†™å¯¹åº”çš„è¾“å‡ºæ–¹æ³•ï¼Œè°ƒç”¨è€…ä½¿ç”¨æŒ‡ä»¤ç±»çš„å¤šæ€å±æ€§å®Œæˆæ¯æ¡æŒ‡ä»¤çš„è¾“å‡ºã€‚ä¸”å½“éœ€è¦æ–°å¢æŒ‡ä»¤æ—¶ï¼Œä¸éœ€è¦ä¿®æ”¹åŸæ¥çš„ä»£ç ï¼Œåªéœ€è¦æ–°å¢ç±»å¹¶ç»§æ‰¿æŠ½è±¡çˆ¶ç±»æˆ–å®ç°æ¥å£å³å¯ã€‚

# 7. ä»£ç ä¼˜åŒ–è®¾è®¡

## 7.1. å¯„å­˜å™¨åˆ†é…

åœ¨ç›®æ ‡ä»£ç ç”Ÿæˆçš„æŒ‡å¯¼ä¹¦ä¸­ï¼š

>åœ¨ MIPS è¿™ç§**å¯„å­˜å™¨åˆ°å¯„å­˜å™¨**æ¨¡å‹ä¸­ï¼Œæ¯ä¸ªå‚ä¸è¿ç®—çš„å€¼éƒ½å¿…é¡»è¢«åŠ è½½åˆ°å¯„å­˜å™¨ä¸­ï¼Œå› æ­¤åœ¨æˆ‘ä»¬çš„ IR ä¸­ï¼Œå‚ä¸è¿ç®—çš„å˜é‡éƒ½åº”è¯¥å¯¹åº”ä¸€ä¸ªå¯„å­˜å™¨ï¼Œåœ¨ IR ä¸­ï¼Œæˆ‘ä»¬å°†å…¶ç§°ä¸º**è™šæ‹Ÿå¯„å­˜å™¨**ã€‚è™šæ‹Ÿå¯„å­˜å™¨æ•°ç›®æ˜¯æ— é™çš„ï¼Œä½†æ˜¯å½“ç¿»è¯‘ä¸ºç›®æ ‡å¹³å°çš„æ±‡ç¼–ä»£ç æ—¶ï¼Œå°±éœ€è¦å°†å…¶æ˜ å°„åˆ°ä¸€ç»„æœ‰é™çš„å¯„å­˜å™¨ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯**å¯„å­˜å™¨åˆ†é…**ã€‚
>
>å¯¹äºè§„èŒƒçš„å¯„å­˜å™¨åˆ†é…ï¼Œåˆ™éœ€è¦è€ƒè™‘**å…¨å±€å¯„å­˜å™¨**å’Œ**å±€éƒ¨å¯„å­˜å™¨**çš„åˆ†é…ï¼Œåˆ†åˆ«å¯¹åº” MIPS ä¸­çš„ `s` å’Œ `t` å¯„å­˜å™¨ã€‚â€¦â€¦

å› æ­¤ï¼Œ**æˆ‘åœ¨ç”Ÿæˆç›®æ ‡ä»£ç æ—¶å°±å·²ç»åˆ†é…äº†å¯„å­˜å™¨**ï¼ˆå› æ­¤ä¼˜åŒ–å‰å’Œä¼˜åŒ–åfinalCycleå·®è·å¯èƒ½ä¸å¤§ï¼‰ã€‚ä»¥ä¸‹æ˜¯å…·ä½“å®ç°æ€è·¯ã€‚

### 7.1.1 è·¨å—æ´»è·ƒå˜é‡ï¼šé‡‡ç”¨å›¾ç€è‰²æ³•åˆ†é…å…¨å±€å¯„å­˜å™¨

#### 7.1.1.1 æ•°æ®æµåˆ†æ

åœ¨LLVM IRæ¯æ¡å…·ä½“æŒ‡ä»¤ç±»ä¸­æ·»åŠ `def`å’Œ`use`é›†ï¼Œå¹¶åœ¨æ„é€ æ–¹æ³•ä¸­å°†å¯¹åº”å˜é‡åŠ å…¥è¿™ä¸¤ä¸ªé›†åˆã€‚

```java
// å½“æœ‰é›†åˆçš„iné›†å‘ç”Ÿå˜åŒ–æ—¶ï¼Œç»§ç»­è¿­ä»£
boolean changed = true;
while(changed) {
    changed = false;
    for (int i = basicBlocks.size() - 1; i >= 0; i--) {
        BasicBlock basicBlock = basicBlocks.get(i);
        // BasicBlockçš„liveOuté›†åˆä¸ºå…¶æ‰€æœ‰åç»§çš„liveIné›†åˆçš„å¹¶é›†
        for (BasicBlock succ: basicBlock.succs) {
            basicBlock.liveOut.addAll(succ.liveIn);
        }
        // è®¡ç®—æ¯æ¡æŒ‡ä»¤çš„iné›†å’Œouté›†
        List<Instruction> instructions = basicBlock.instructions;
        // BasicBlockçš„æœ€åä¸€æ¡æŒ‡ä»¤çš„liveOuté›†åˆå³ä¸ºliveOuté›†åˆ
        Set<Slot> succsLiveIn = new HashSet<>(basicBlock.liveOut);
        for (int j = instructions.size() - 1; j >= 0; j--) {
            Instruction instruction = instructions.get(j);
            instruction.liveOut = new HashSet<>(succsLiveIn);   // æ¯æ¡æŒ‡ä»¤çš„liveOuté›†åˆä¸ºå…¶åç»§çš„liveIné›†åˆ
            instruction.liveIn = new HashSet<>(instruction.liveOut);
            instruction.liveIn.removeAll(instruction.def);
            instruction.liveIn.addAll(instruction.use);
            succsLiveIn = new HashSet<>(instruction.liveIn);
        }
        // æœ€åä¸€æ¡æŒ‡ä»¤çš„liveIné›†åˆå³ä¸ºBasicBlockçš„liveIné›†åˆ
        if (!basicBlock.liveIn.equals(succsLiveIn)) {
            changed = true;
            basicBlock.liveIn = new HashSet<>(succsLiveIn);
        }
    }
```

åœ¨å¯¹æ¯æ¡æŒ‡ä»¤çš„`liveIn`å’Œ`liveOut`é›†è®¡ç®—çš„åŸºç¡€ä¸Šï¼Œè®¡ç®—åŸºæœ¬å—çš„`liveIn`å’Œ`liveOut`é›†ã€‚

éœ€è¦æ³¨æ„åœ¨è®¡ç®—å‡½æ•°çš„è·¨å—æ´»è·ƒå˜é‡æ—¶ï¼Œå°†æ‰€æœ‰çš„`liveIn`å’Œ`liveOut`é›†å˜é‡åŠ å…¥åï¼Œéœ€è¦åˆ é™¤æ‰€æœ‰ä½œä¸ºå‡½æ•°å‚æ•°çš„å˜é‡ï¼ˆåŒ…æ‹¬æŒ‡é’ˆå‹ï¼‰ã€‚
è¿™æ˜¯å› ä¸ºå‡½æ•°å‚æ•°ä¸€æ¦‚ä¸åˆ†é…å¯„å­˜å™¨ï¼Œå› æ­¤å°½ç®¡åœ¨å‚æ•°ä¸­å‡ºç°ï¼Œä¹Ÿä¸åŠ å…¥è·¨å—æ´»è·ƒå˜é‡é›†åˆã€‚

#### 7.1.1.2 å›¾ç€è‰²ç®—æ³•

ä¸ºäº†ç®€ä¾¿ï¼Œæˆ‘åœ¨å®ç°ä¸­å¯¹å†²çªçš„å®šä¹‰æ˜¯ï¼šæ´»è·ƒèŒƒå›´é‡åˆã€‚å› æ­¤ï¼Œåœ¨æ•°æ®æµåˆ†æåï¼ŒåŒæ—¶å‡ºç°åœ¨`liveIn`æˆ–`liveOut`é›†åˆçš„ã€ä»¥åŠåœ¨å—å†…æ´»è·ƒèŒƒå›´å†²çªçš„å˜é‡è§†ä¸ºå†²çªã€‚

```java
// æ„é€ å†²çªå›¾
Graph graph = new Graph(); // ç”¨äºç§»é™¤èŠ‚ç‚¹å¾—åˆ°é˜Ÿåˆ—
Graph conflict = new Graph(); // å‰¯æœ¬ï¼Œç”¨äºä¿å­˜å†²çªå›¾
for (Slot node: function.interBlockLive) {
    graph.addNode(node);
    conflict.addNode(node);
}
// åœ¨liveInå’ŒliveOutä¸­åŒæ—¶å‡ºç°çš„å˜é‡ï¼Œå³ä¸ºå†²çªå˜é‡ï¼Œæ·»åŠ è¾¹
for (BasicBlock block: function.basicBlocks) {
    for (Slot slot1: block.liveIn) {
        for (Slot slot2: block.liveIn) {
            if (slot1 != slot2 &&
                function.interBlockLive.contains(slot1) &&
                function.interBlockLive.contains(slot2)) {
                graph.addEdge(slot1, slot2);
                conflict.addEdge(slot1, slot2);
            }
        }
    }
    for (Slot slot1: block.liveOut) {
        for (Slot slot2: block.liveOut) {
            if (slot1 != slot2 &&
                function.interBlockLive.contains(slot1) &&
                function.interBlockLive.contains(slot2)) {
                graph.addEdge(slot1, slot2);
                conflict.addEdge(slot1, slot2);
            }
        }
    }
}
// å¯¹æ¯ä¸ªåŸºæœ¬å—ï¼Œæ£€æŸ¥åªå‡ºç°åœ¨ in æˆ– out ä¸­çš„å˜é‡ï¼Œè‹¥æ´»æ€§èŒƒå›´å†²çªåˆ™ä¹Ÿæ·»åŠ å†²çªè¾¹
for (BasicBlock block: function.basicBlocks) {
    Set<Slot> intersection = new HashSet<>(block.liveIn);   // äº¤é›†
    intersection.retainAll(block.liveOut);

    Set<Slot> liveInRemoveInter = new HashSet<>(block.liveIn);
    liveInRemoveInter.removeAll(intersection);
    Set<Slot> liveOutRemoveInter = new HashSet<>(block.liveOut);
    liveOutRemoveInter.removeAll(intersection);

    for (Slot slot1: liveInRemoveInter) {
        for (Slot slot2: liveOutRemoveInter) {
            if (function.interBlockLive.contains(slot1) &&
                    function.interBlockLive.contains(slot2)) {
                // æ»¤å»å‡½æ•°å‚æ•°ç­‰ä¸è·¨å—æ´»è·ƒçš„å˜é‡
                Instruction defInst = null;
                for (Instruction inst: block.instructions) {
                    if (inst.def.contains(slot2)) {
                        // slot2åªå‡ºç°åœ¨liveOutä¸­ï¼Œåˆ™æœ‰ä¸€æ¡å®šä¹‰å®ƒçš„æŒ‡ä»¤
                        defInst = inst;
                        break;
                    }
                }
                // å®šä¹‰åï¼Œslot1ä»æ´»è·ƒï¼Œå³ä¸ºå†²çª
                if (defInst.liveOut.contains(slot1)) {
                    graph.addEdge(slot1, slot2);
                    conflict.addEdge(slot1, slot2);
                }
            }
        }
    }
}
```

å…¶ä¸­ä¿å­˜å†²çªå›¾çš„å‰¯æœ¬æ˜¯ä¸ºäº†åœ¨åç»­ç§»èµ°èŠ‚ç‚¹ä¹Ÿèƒ½æŸ¥è¯¢åˆ°æ¯ä¸ªå˜é‡çš„å†²çªæƒ…å†µã€‚

```java
LinkedList<Slot> queue = new LinkedList<>();
// æ‰§è¡Œå›¾ç€è‰²ç®—æ³•
while (graph.getNodesNum() > 0) {
    boolean canRemove = false;
    // ã€ä¸ºä¿è¯ç§»å‡ºé¡ºåºï¼Œå…ˆå¯¹é‚»æ¥è¡¨æ’åºã€‘
    List<Map.Entry<Slot, Set<Slot>>> list = new ArrayList<>(graph.adjacencyList.entrySet());
    list.sort(Comparator.comparingInt(o -> o.getKey().slotId));
    for (Map.Entry<Slot, Set<Slot>> entry : list) {
        if (graph.getDegree(entry.getKey()) < RegisterPool.savedRegisters.size()) {
            queue.addLast(entry.getKey());
            graph.removeNode(entry.getKey());
            canRemove = true;
            System.out.println("remove " + entry.getKey().toText());
            break;
        }
    }
    if (!canRemove) {
        // è‹¥æ— æ³•åˆ é™¤èŠ‚ç‚¹ï¼Œå³å›¾ä¸­å­˜åœ¨åº¦æ•°å¤§äºç­‰äºå¯„å­˜å™¨æ•°é‡çš„èŠ‚ç‚¹ï¼Œä¿å­˜åœ¨æ ˆä¸Š
        // TODO: ä¼˜åŒ–æ—¶ï¼Œé€‰æ‹©å¼•ç”¨æ¬¡æ•°æœ€å°‘çš„èŠ‚ç‚¹è¿›è¡Œåˆå¹¶
        Slot remove = list.get(0).getKey();
        graph.removeNode(remove);
        conflict.removeNode(remove);    // ã€ä¸åˆ†é…ï¼Œç§»å‡ºå†²çªå›¾ã€‘
        System.out.println("spill " + remove.toText());
    }
}
// æŒ‰ç…§ç»“ç‚¹ç§»èµ°çš„åå‘é¡ºåºå°†ç‚¹å’Œè¾¹æ·»åŠ å›å»ï¼Œå¹¶åˆ†é…é¢œè‰²
while (!queue.isEmpty()) {
    Slot slot = queue.removeLast();
    graph.addNode(slot);
    List<Register> available = new LinkedList<>(RegisterPool.savedRegisters);
    for (Map.Entry<Slot, Set<Slot>> entry: graph.adjacencyList.entrySet()) {
        if (conflict.adjacencyList.get(slot).contains(entry.getKey())) {
            // è‹¥å·²åœ¨å›¾ä¸­çš„èŠ‚ç‚¹ä¸æ­¤èŠ‚ç‚¹å­˜åœ¨å†²çª
            available.remove(registerPool.globalAllocation.get(entry.getKey()));
            graph.addEdge(slot, entry.getKey());
        }
    }
    // æŒ‘é€‰ä¸€ä¸ªå¯ç”¨çš„å¯„å­˜å™¨ç€è‰²
    assert !available.isEmpty();
    registerPool.globalAllocation.put(slot, available.get(0));
}
```

è¿™é‡Œå¯¹äºé€‰æ‹©å“ªä¸ªèŠ‚ç‚¹ç§»é™¤æš‚æ—¶æ²¡æœ‰å®ç°é€‰æ‹©ç®—æ³•ï¼Œåç»­å¯èƒ½ä¼˜åŒ–ä¸ºå¼•ç”¨æ¬¡æ•°æœ€å°‘çš„ä¸åˆ†é…å…¨å±€å¯„å­˜å™¨ã€‚

éœ€è¦æ³¨æ„ç”±äº`HashMap`éå†é¡ºåºçš„ä¸ç¡®å®šæ€§ï¼Œéœ€è¦å…ˆå°†å…¶æ’åºå†è¿›è¡Œåç»­æ“ä½œã€‚

### 7.1.2 ä¸è·¨å—æ´»è·ƒçš„å˜é‡ï¼šé‡‡ç”¨å¯„å­˜å™¨æ± åˆ†é…ä¸´æ—¶å¯„å­˜å™¨

åœ¨åç«¯å®ç°äº†ä¸€ä¸ª`RegisterPool.java`ç±»ï¼Œè™½ç„¶å…¨å±€å¯„å­˜å™¨ä¸ä½¿ç”¨å¯„å­˜å™¨æ± åˆ†é…ï¼Œä½†æ˜¯å®ç°è¿™ä¸ªç±»å¯ä»¥ä¾¿äºå¯¹å˜é‡å¯¹åº”çš„å¯„å­˜å™¨ç»Ÿä¸€ç®¡ç†ã€‚ç”Ÿæˆç›®æ ‡ä»£ç æ—¶ï¼Œå¯ä»¥ç»Ÿä¸€ä½¿ç”¨æä¾›çš„æ¥å£æ‰¾åˆ°å¯¹åº”çš„å¯„å­˜å™¨ã€‚

æ€»çš„æ¥è¯´ï¼Œæˆ‘å®ç°çš„ä¸´æ—¶å¯„å­˜å™¨æ± ä½¿ç”¨**FIFOç®—æ³•**ï¼Œç»´æŠ¤ä¸€ä¸ª`allocated`è¡¨å’Œ`tempQueue`ï¼Œå‰è€…å­˜å‚¨å˜é‡å¯¹åº”çš„å¯„å­˜å™¨ï¼Œåè€…æ˜¯ä¸€ä¸ªè®°å½•åˆ†é…é¡ºåºçš„é˜Ÿåˆ—ã€‚å½“æ–°å¢å˜é‡æ—¶ï¼Œä»å¯„å­˜å™¨æ± ä¸­åˆ†é…ä¸€ä¸ªå˜é‡ï¼Œå¹¶æ·»åŠ `allocated`è¡¨é¡¹ã€åŠ å…¥`tempQueue`é˜Ÿå°¾ï¼›å½“é‡Šæ”¾å¯„å­˜å™¨æ—¶ï¼Œç§»é™¤`allocated`è¡¨é¡¹ä»¥åŠ`tempQueue`å¯¹åº”å¯„å­˜å™¨ï¼›å½“å¯„å­˜å™¨ä¸å¤Ÿéœ€è¦æº¢å‡ºæ—¶ï¼Œå–`tempQueue`çš„é˜Ÿé¦–æº¢å‡ºåˆ°å†…å­˜å¹¶åˆ†é…ã€‚

```java
/**
 * åˆ†é…ä¸´æ—¶å¯„å­˜å™¨å¹¶ä¸Slotã€ç»‘å®šã€‘
 * @param slot éœ€è¦åˆ†é…çš„slot
 * @param curStackFrame å½“å‰çš„æ ˆå¸§
 * @return åˆ†é…çš„å¯„å­˜å™¨
 */
private Register bindAllocTemp(Slot slot, StackFrame curStackFrame) {
    // å¦‚æœæ˜¯è·¨å—æ´»è·ƒå˜é‡ï¼Œåˆ†é…ä¿ç•™å¯„å­˜å™¨ï¼Œå¦åˆ™åˆ†é…ä¸´æ—¶å¯„å­˜å™¨
    for (Register r: tempRegisters) {
        if (!allocated.containsValue(r)) {
            // è‹¥ç©ºé—²ï¼Œå³æ‰¾åˆ°
            tempQueue.addLast(r);
            allocated.put(slot, r);
            return r;
        }
    }
    // æº¢å‡ºå¤„ç†
    return spill(slot, curStackFrame);
}

/**
 * æº¢å‡ºå¤„ç†ï¼Œå°†æº¢å‡ºå¯„å­˜å™¨çš„å€¼å­˜åˆ°æ ˆä¸Š
 * @param curStackFrame å½“å‰çš„æ ˆå¸§
 * @param slot éœ€è¦åˆ†é…çš„slotï¼Œå¯ä¸ºnull
 */
private Register spill(Slot slot, StackFrame curStackFrame) {
    // FIFOç®—æ³•ï¼Œå–å‡ºæœ€æ—©åˆ†é…çš„å¯„å­˜å™¨
    Register spillRegister = tempQueue.removeFirst();
    Slot spillSlot = null;
    for (Map.Entry<Slot, Register> entry: allocated.entrySet()) {
        if (entry.getValue() == spillRegister) {
            spillSlot = entry.getKey();
        }
    }
    // å°†å¯„å­˜å™¨çš„å€¼å­˜åˆ°æ ˆä¸Š
    curStackFrame.recordLocal(spillSlot, 4);
    mipsCode.addMIPSInst(new SW(spillRegister, Register.SP, -curStackFrame.getSize()).setComment("\tspill reg of " + spillSlot.toText()));
    // ç§»é™¤allocatedä¸­çš„è®°å½•
    allocated.remove(spillSlot);
    if (slot != null) {
        tempQueue.addLast(spillRegister);
        allocated.put(slot, spillRegister);
    }
    return spillRegister;
}
```

å› æ­¤ï¼Œæ¯æ¡æŒ‡ä»¤çš„ç¿»è¯‘æ­¥éª¤å³ï¼š

> 1. ä½¿ç”¨ find è·å– use çš„å¯„å­˜å™¨
> 2. ä½¿ç”¨ deallocUse å›æ”¶ use ä¸­ä¸æ´»è·ƒå˜é‡çš„å¯„å­˜å™¨
> 3. ä½¿ç”¨ allocDef åˆ†é… def ä½¿ç”¨çš„å¯„å­˜å™¨ã€allocDefå¯èƒ½è¿”å›nullï¼Œæ­¤æ—¶éœ€è¦ä¿å­˜åˆ°æ ˆä¸Šã€‘
> 4. ä½¿ç”¨ allocTemp åˆ†é…ä¸ç»‘å®šslotçš„å¯„å­˜å™¨
> 5. ç”ŸæˆMIPSæŒ‡ä»¤

è¿™äº›æ­¥éª¤ä¸èƒ½éšæ„è°ƒæ¢é¡ºåºã€‚å…·ä½“æ¥è¯´ï¼š

- å…ˆ`find`å†`deallocUse`ï¼ˆå¦åˆ™æ‰¾ä¸åˆ°å°±é‡Šæ”¾äº†ï¼‰
- å…ˆ`deallocUse`å†`allocDef`ï¼ˆè¿™æ ·å¯ä»¥ç«‹å³ä½¿ç”¨useä¸å†ä½¿ç”¨çš„å¯„å­˜å™¨ï¼Œä¾‹å¦‚addiu \$t0, \$t0, -4è¿™ç§æŒ‡ä»¤ï¼‰
- å…ˆ`allocDef`å†`allocTemp`ã€‚ï¼ˆå¦åˆ™ï¼Œå› ä¸ºåè€…ä¸ç»‘å®šSlotï¼Œä¼šåˆ†é…åˆ°ä¸€æ ·çš„å¯„å­˜å™¨è€Œå‡ºé”™ï¼‰

> æ­¤ä¼˜åŒ–ä¸MIPSç”Ÿæˆä¸€èµ·å®Œæˆï¼Œå› æ­¤æäº¤çš„ä¼˜åŒ–å‰ç›®æ ‡ä»£ç ä¸æ­¤ä¸€è‡´ã€‚

## 7.2. åŸºæœ¬å—åˆå¹¶

ä¾‹å¦‚ï¼Œåœ¨å…¬å¼€testcase7ä¸­ï¼Œç”Ÿæˆäº†å¦‚ä¸‹ä»£ç ï¼š

```assembly
101:                          ; preds = 96
    %102 = load i32, i32* %1      ;load value of i
    %103 = getelementptr [10 x i32], [10 x i32]* @a, i32 0, i32 %102      ;get &a[%102]
    %104 = load i32, i32* %103    ;load value of a[%102]
    call void @putint(i32 %104)
    call void @putstr(i8* getelementptr inbounds ([3 x i8], [3 x i8]* @.str.0, i64 0, i64 0))
    %105 = load i32, i32* %1      ;load value of i
    %106 = add i32 %105, 1
    store i32 %106, i32* %1
    br label %107
107:                          ; preds = 101
    br label %96
108:								 ; preds = 96
```

ç»è¿‡åŸºæœ¬å—åˆå¹¶ä¼˜åŒ–åï¼š

```assembly
101:                          ; preds = 96
    %102 = load i32, i32* %1      ;load value of i
    %103 = getelementptr [10 x i32], [10 x i32]* @a, i32 0, i32 %102      ;get &a[%102]
    %104 = load i32, i32* %103    ;load value of a[%102]
    call void @putint(i32 %104)
    call void @putstr(i8* getelementptr inbounds ([3 x i8], [3 x i8]* @.str.0, i64 0, i64 0))
    %105 = load i32, i32* %1      ;load value of i
    %106 = add i32 %105, 1
    store i32 %106, i32* %1
    br label %96
107:                          ; preds = 96
```

## 7.3. ä¹˜é™¤æ³•ä¼˜åŒ–

åªé’ˆå¯¹ç¬¬äºŒä¸ªæ“ä½œæ•°ä¸ºç«‹å³æ•°çš„ä¹˜é™¤æŒ‡ä»¤è¿›è¡Œä¼˜åŒ–ã€‚

### 7.3.1 ä¹˜æ³•ä¼˜åŒ–

å¯¹äºä¹˜æ•°ä¸º0ã€1ã€2çš„æ•´æ•°å¹‚ã€2çš„æ•´æ•°å¹‚çš„ç›¸åæ•°ã€2çš„æ•´æ•°å¹‚-1ã€2çš„æ•´æ•°å¹‚-2ã€2çš„æ•´æ•°å¹‚+1è¿›è¡Œä¼˜åŒ–ï¼Œè½¬ä¸ºè‹¥å¹²ç§»ä½æŒ‡ä»¤å’ŒåŠ å‡æŒ‡ä»¤ã€‚

### 7.3.2 é™¤æ³•ä¼˜åŒ–

å¯¹äºé™¤æ•°ä¸º2çš„æ•´æ•°å¹‚ã€2çš„æ•´æ•°å¹‚çš„ç›¸åæ•°è¿›è¡Œä¼˜åŒ–ã€‚

æ­¤å¤–ï¼Œå¯¹äºèƒ½è½¬åŒ–ä¸ºä¹˜æ³•å’Œç§»ä½è¿ç®—çš„è¿›è¡Œä¼˜åŒ–ï¼Œä¾‹å¦‚å¯¹äºtestcase7ä¸­ï¼š

```assembly
	div $t0, $t0, 5
```

è¢«ä¼˜åŒ–ä¸ºï¼š

```assembly
    slt $t1, $zero, $t0
    bnez $t1, _L_divOptimize_0
    subu $t0, $zero, $t0
_L_divOptimize_0:
    li $t2, 3435973837
    multu $t0, $t2
    mfhi $t0
    sra $t0, $t0, 2
    bnez $t1, _L_divOptimize_1
    subu $t0, $zero, $t0
_L_divOptimize_1:
```

éœ€è¦æ³¨æ„ï¼Œä¼˜åŒ–æ—¶ï¼Œéœ€è¦åˆ†æ­£è´Ÿä¸¤ç§æƒ…å†µï¼Œä¸ç„¶ä¼šäº§ç”Ÿé”™è¯¯ã€‚

## å…¶ä»–è¯´æ˜

ç”±äºç”ŸæˆMIPSæ—¶ç›´æ¥å®Œæˆå¯„å­˜å™¨åˆ†é…è¿™ä¸€â€œä¼˜åŒ–ä»»åŠ¡â€ï¼Œå› æ­¤è€—è´¹äº†è®¸å¤šæ—¶é—´ã€‚æœ€åå› æ—¶é—´ç´§è¿«ï¼Œå…¶ä»–ä¼˜åŒ–æš‚æ—¶æ²¡æœ‰å®Œæˆã€‚

>Authorï¼šbush
>
>æ›´æ–°æ—¥å¿—ï¼š
>
>- 2024.9.24ï¼šå®Œæˆè¯æ³•åˆ†æï¼Œå®Œæˆæ–‡æ¡£#1ã€#2ã€#3
>- 2024.10.14ï¼šå®Œæˆè¯­æ³•åˆ†æåŠæ­¤éƒ¨åˆ†æ–‡æ¡£#4ï¼Œä¿®æ”¹#2.2ï¼Œæ–°å¢#3.2.3
>- 2024.10.19ï¼šåœ¨æœŸä¸­æ¨¡æ‹Ÿè€ƒå‘ç°å›æº¯æ—¶æœªå›æº¯å·²æŠ›å‡ºé”™è¯¯å¯¼è‡´å¤šè¾“å‡ºé”™è¯¯ï¼Œä¿®æ”¹#4.2.5
>- 2024.11.2ï¼šå®Œæˆè¯­ä¹‰åˆ†æï¼Œå®Œæˆæ–‡æ¡£#5
>- 2024.12.12ï¼šå®ŒæˆMIPSä»£ç ç”Ÿæˆï¼Œå®Œæˆæ–‡æ¡£#6
>- 2024.12.17ï¼šå®Œæˆä¼˜åŒ–æ–‡æ¡£#7

